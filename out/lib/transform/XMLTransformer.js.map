{"version":3,"file":"XMLTransformer.js","names":["_os","require","_modifyXml","_Transformer","_SplittingTransformer","_interopRequireDefault","e","__esModule","default","_objectWithoutProperties","t","o","r","i","_objectWithoutPropertiesLoose","Object","getOwnPropertySymbols","n","length","indexOf","propertyIsEnumerable","call","hasOwnProperty","walk","element","action","filter","isElement","childNodes","child","XMLTransformer","SplittingTransformer","constructor","_ref","sortXMLAttributes","removeBuilderRefs","options","build","object","buildOptions","root","find","moveToTop","attributes","a","includes","name","sort","b","openTag","render","indent","repeat","spaces","_fromDBBuilder","xml","compact","replace","EOL","_fromFilesystemBuilder","sortedAttributeValues","node","attributeValues","fromEntries","entries","builder","direction","TransformDirection","FromDB","decodeContents","rawLines","value","toString","stringValue","parse","error","line","assign","location","start","column","encodeContents","exports"],"sources":["../../../src/lib/transform/XMLTransformer.js"],"sourcesContent":["import { EOL } from 'os';\r\nimport { parse, render, isElement, moveToTop, attributeValues } from 'modify-xml';\r\nimport { TransformDirection } from './Transformer';\r\nimport SplittingTransformer from './SplittingTransformer';\r\n\r\nfunction walk(element, action, filter = isElement) {\r\n  action(element);\r\n\r\n  if (element.childNodes) {\r\n    for (const child of element.childNodes.filter((n) => filter(n))) {\r\n      walk(child, action);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * A transformer used to transform XML documents.\r\n */\r\nexport default class XMLTransformer extends SplittingTransformer {\r\n  /**\r\n   * Creates a new XMLTransformer based on some options.\r\n   * @param {Object} [options] The options to use.\r\n   */\r\n  constructor({ sortXMLAttributes = false, removeBuilderRefs = false, ...options } = {}) {\r\n    super(options);\r\n\r\n    /** @protected */\r\n    this.sortXMLAttributes = sortXMLAttributes;\r\n\r\n    /** @protected */\r\n    this.removeBuilderRefs = removeBuilderRefs;\r\n\r\n    function build(object, buildOptions) {\r\n      const root = object.childNodes.find((n) => isElement(n));\r\n\r\n      if (root) {\r\n        moveToTop(root, 'metadata');\r\n        moveToTop(root, 'defs');\r\n        moveToTop(root, 'desc');\r\n        moveToTop(root, 'title');\r\n      }\r\n\r\n      if (sortXMLAttributes || removeBuilderRefs)\r\n        walk(root, (e) => {\r\n          /* eslint-disable no-param-reassign */\r\n          if (removeBuilderRefs)\r\n            e.attributes = e.attributes.filter((a) => !['atv:refpx', 'atv:refpy'].includes(a.name));\r\n\r\n          if (sortXMLAttributes)\r\n            e.attributes = e.attributes.sort((a, b) => (b.name > a.name ? -1 : 1));\r\n\r\n          delete e.openTag;\r\n          /* eslint-enable no-param-reassign */\r\n        });\r\n\r\n      return render(object, { indent: ' '.repeat(buildOptions.spaces) });\r\n    }\r\n\r\n    // eslint-disable-next-line jsdoc/require-param\r\n    /**\r\n     * The builder to use with direction {@link TransformDirection.FromDB}.\r\n     * @type {function(object: Object): string}\r\n     */\r\n    this._fromDBBuilder = (object) => {\r\n      const xml = build(object, { compact: false, spaces: 2 });\r\n      return xml.replace(/\\r?\\n/g, EOL);\r\n    };\r\n\r\n    // eslint-disable-next-line jsdoc/require-param\r\n    /**\r\n     * The builder to use with direction {@link TransformDirection.FromFilesystem}.\r\n     * @type {function(object: Object): string}\r\n     */\r\n    this._fromFilesystemBuilder = (object) => {\r\n      const xml = build(object, { compact: false, spaces: 1 });\r\n      return xml.replace(/\\r?\\n/g, '\\n');\r\n    };\r\n  }\r\n\r\n  /**\r\n   * @protected\r\n   * @param {import('modify-xml').Element} node The node to handle.\r\n   */\r\n  sortedAttributeValues(node) {\r\n    if (!this.sortXMLAttributes) return attributeValues(node);\r\n\r\n    return Object.fromEntries(\r\n      Object.entries(attributeValues(node)).sort((a, b) => (b > a ? -1 : 1))\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Returns the XML builder to use based on the current {@link Transformer#direction}.\r\n   * @type {function(object: Object): string}\r\n   */\r\n  get builder() {\r\n    return this.direction === TransformDirection.FromDB\r\n      ? this._fromDBBuilder\r\n      : this._fromFilesystemBuilder;\r\n  }\r\n\r\n  /**\r\n   * Parses XML in a node's contents.\r\n   * @param {Node | BrowsedNode} node The node to process.\r\n   */\r\n  decodeContents(node) {\r\n    const rawLines =\r\n      this.direction === TransformDirection.FromDB ? node.value.value.toString() : node.stringValue;\r\n\r\n    try {\r\n      return parse(rawLines);\r\n    } catch (error) {\r\n      if (error.line) {\r\n        Object.assign(error, {\r\n          rawLines,\r\n          location: {\r\n            start: {\r\n              line: error.line + 1,\r\n              column: error.column + 1,\r\n            },\r\n          },\r\n        });\r\n      }\r\n\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Builds an XML string from an object.\r\n   * @param {Object} object The object to encode.\r\n   */\r\n  encodeContents(object) {\r\n    return this.builder(object);\r\n  }\r\n}\r\n"],"mappings":"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","ignoreList":[]}
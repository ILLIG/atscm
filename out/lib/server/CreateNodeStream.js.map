{"version":3,"file":"CreateNodeStream.js","names":["_opcua_status_code","require","_variant","_nodeclass","_gulplog","_interopRequireDefault","_NodeId","_Node","_CallScriptStream","e","__esModule","default","CreateNodeStream","CallScriptStream","scriptId","NodeId","NodeIdType","STRING","scriptParameters","file","options","nodeId","parentNodeId","parent","nodeClass","value","typeDefinition","browseName","idName","toParentRefs","references","get","ReferenceTypeIds","toParent","reference","ReferenceTypeNames","rules","HasModellingRule","modellingRule","NodeClass","Variable","dataType","variantValue","valueRank","arrayType","paramObjString","DataType","String","JSON","stringify","processErrorMessage","handleOutputArguments","outArgs","callback","StatusCodes","Good","Error","createdNode","createFailed","Logger","warn","toString","debug","push","exports"],"sources":["../../../src/lib/server/CreateNodeStream.js"],"sourcesContent":["import { StatusCodes } from 'node-opcua/lib/datamodel/opcua_status_code';\r\nimport { DataType } from 'node-opcua/lib/datamodel/variant';\r\nimport { NodeClass } from 'node-opcua/lib/datamodel/nodeclass';\r\nimport Logger from 'gulplog';\r\nimport NodeId from '../model/opcua/NodeId';\r\nimport { ReferenceTypeIds, ReferenceTypeNames } from '../model/Node';\r\nimport CallScriptStream from './scripts/CallScriptStream';\r\n\r\n/**\r\n * A stream that creates OPC-UA nodes for the passed {@link AtviseFiles}s.\r\n */\r\nexport default class CreateNodeStream extends CallScriptStream {\r\n  /**\r\n   * Id of the *CreateNode* script added with `atscm import`.\r\n   * @type {NodeId}\r\n   */\r\n  get scriptId() {\r\n    return new NodeId(\r\n      NodeId.NodeIdType.STRING,\r\n      'SYSTEM.LIBRARY.ATVISE.SERVERSCRIPTS.atscm.CreateNode',\r\n      1\r\n    );\r\n  }\r\n\r\n  /**\r\n   * The options required to create a node for the given file.\r\n   * @param {AtviseFile} file The processed file.\r\n   * @return {Object} The options passed to the *CreateNode* script.\r\n   */\r\n  scriptParameters(file) {\r\n    const options = {\r\n      nodeId: file.nodeId,\r\n      parentNodeId: file.parent ? file.parent.nodeId : 85,\r\n      nodeClass: file.nodeClass.value,\r\n      typeDefinition: file.typeDefinition,\r\n      browseName: file.idName,\r\n    };\r\n\r\n    const toParentRefs = file.references.get(ReferenceTypeIds.toParent);\r\n    if (toParentRefs) {\r\n      options.reference = ReferenceTypeNames[[...toParentRefs][0]];\r\n    }\r\n\r\n    const rules = file.references.get(ReferenceTypeIds.HasModellingRule);\r\n    if (rules) {\r\n      options.modellingRule = [...rules][0];\r\n    }\r\n\r\n    if (file.nodeClass.value === NodeClass.Variable.value) {\r\n      options.dataType = file.variantValue.dataType.value;\r\n      options.valueRank = file.variantValue.arrayType.value;\r\n      options.value = file.variantValue.value;\r\n    }\r\n\r\n    return {\r\n      paramObjString: {\r\n        dataType: DataType.String,\r\n        value: JSON.stringify(options),\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Prints an error message telling that creating a node failed.\r\n   * @param {AtviseFile} file The file who's node could not be created.\r\n   * @return {string} The resulting error message.\r\n   */\r\n  processErrorMessage(file) {\r\n    return `Error creating node ${file.nodeId}`;\r\n  }\r\n\r\n  /**\r\n   * Handles the results of a script call.\r\n   * @param {AtviseFile} file The file the script was called with.\r\n   * @param {node-opcua~Variant[]} outArgs The raw method results.\r\n   * @param {function(err: Error)} callback Called once finished.\r\n   */\r\n  handleOutputArguments(file, outArgs, callback) {\r\n    if (outArgs[0].value !== StatusCodes.Good) {\r\n      callback(new Error(outArgs[1].value));\r\n    } else {\r\n      const [{ value: createdNode }, { value: createFailed }] = outArgs[3].value;\r\n\r\n      if (createFailed) {\r\n        Logger.warn('Failed to create node', file.nodeId.toString());\r\n      } else if (createdNode) {\r\n        Logger.debug('Created node', file.nodeId.toString());\r\n        this.push(file);\r\n      } else {\r\n        Logger.debug('Node', file.nodeId.toString(), 'already exists');\r\n        this.push(file);\r\n      }\r\n\r\n      callback(null);\r\n    }\r\n  }\r\n}\r\n"],"mappings":"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","ignoreList":[]}
{"version":3,"file":"CallMethodStream.js","names":["_opcua_status_code","require","_QueueStream","_interopRequireDefault","e","__esModule","default","CallMethodStream","QueueStream","methodId","Error","methodBaseId","parent","inputArguments","file","callRequest","args","objectId","handleOutputArguments","outputArgs","callback","processErrorMessage","toString","relative","processChunk","handleErrors","request","StatusCodes","Good","done","session","call","err","result","statusCode","value","outputArguments","outputError","exports"],"sources":["../../../../src/lib/server/scripts/CallMethodStream.js"],"sourcesContent":["import { StatusCodes } from 'node-opcua/lib/datamodel/opcua_status_code';\r\nimport QueueStream from '../QueueStream';\r\n\r\n/**\r\n * A stream that calls an OPC-UA method for all input files.\r\n * @abstract\r\n */\r\nexport default class CallMethodStream extends QueueStream {\r\n  /**\r\n   * **Must be implemented in all subclasses:** The {@link NodeId} of the method to call.\r\n   * @type {NodeId} The method's id.\r\n   */\r\n  get methodId() {\r\n    throw new Error('Must be implemented in all subclasses');\r\n  }\r\n\r\n  /**\r\n   * The {@link NodeId} of the object from which the method should get called. Defaults to the value\r\n   * of {@link NodeId#parent} of {@link CallMethodStream#methodId}.\r\n   * @type {NodeId} The call-object's id.\r\n   */\r\n  get methodBaseId() {\r\n    return this.methodId.parent;\r\n  }\r\n\r\n  /**\r\n   * The input arguments the method should be called with for a file. Needs to be overridden by\r\n   * subclasses in most cases. Returning `null` indicates no method call is needed.\r\n   * @param {vinyl~File} file The file beeing processed.\r\n   * @return {?node-opcua~Variant[]} The resulting input arguments.\r\n   */\r\n  // eslint-disable-next-line no-unused-vars\r\n  inputArguments(file) {\r\n    return [];\r\n  }\r\n\r\n  /**\r\n   * Creates a call method request object for a file.\r\n   * @param {vinyl~File} file The file beeing processed.\r\n   * @return {?node-opcua~CallMethodRequest} The resulting call request.\r\n   */\r\n  callRequest(file) {\r\n    const args = this.inputArguments(file);\r\n\r\n    if (args === null) {\r\n      return null;\r\n    }\r\n\r\n    return {\r\n      objectId: this.methodBaseId,\r\n      methodId: this.methodId,\r\n      inputArguments: args,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * **Must be implemented by all subclasses:** If the method call returns a status code of\r\n   * *{@link node-opcua~StatusCodes}.Good*, this method decides if the output matches the expected\r\n   * results.\r\n   * @param {vinyl~File} file The file beeing processed.\r\n   * @param {node-opcua~Variant[]} outputArgs The output arguments.\r\n   * @param {function(err: Error)} callback Call this method with an error to indicate the method\r\n   * call didn't work as expected.\r\n   */\r\n  // eslint-disable-next-line no-unused-vars\r\n  handleOutputArguments(file, outputArgs, callback) {\r\n    throw new Error('Must be implemented in all subclasses');\r\n  }\r\n\r\n  /**\r\n   * Returns an error message specifically for the given file.\r\n   * @param {vinyl~File} file The file to generate the error message for.\r\n   * @return {string} The specific error message.\r\n   */\r\n  processErrorMessage(file) {\r\n    return `Error running ${this.methodId.toString()} for ${file.relative}`;\r\n  }\r\n\r\n  /**\r\n   * Performs an opcua method call for the given file.\r\n   * @param {vinyl~File} file The file being processed.\r\n   * @param {function(err: Error, status: node-opcua~StatusCodes, success: function)} handleErrors\r\n   * The error handler to call. See {@link QueueStream#processChunk} for details.\r\n   */\r\n  processChunk(file, handleErrors) {\r\n    try {\r\n      const request = this.callRequest(file);\r\n\r\n      if (!request) {\r\n        handleErrors(null, StatusCodes.Good, (done) => done());\r\n        return;\r\n      }\r\n\r\n      this.session.call([request], (err, [result] = []) => {\r\n        if (err) {\r\n          handleErrors(err);\r\n        } else if (result.statusCode.value !== StatusCodes.Good.value) {\r\n          handleErrors(err, result.statusCode, (done) => done());\r\n        } else {\r\n          this.handleOutputArguments(file, result.outputArguments, (outputError) => {\r\n            handleErrors(outputError, StatusCodes.Good, (done) => done());\r\n          });\r\n        }\r\n      });\r\n    } catch (e) {\r\n      handleErrors(e);\r\n    }\r\n  }\r\n}\r\n"],"mappings":";;;;;;AAAA,IAAAA,kBAAA,GAAAC,OAAA;AACA,IAAAC,YAAA,GAAAC,sBAAA,CAAAF,OAAA;AAAyC,SAAAE,uBAAAC,CAAA,WAAAA,CAAA,IAAAA,CAAA,CAAAC,UAAA,GAAAD,CAAA,KAAAE,OAAA,EAAAF,CAAA;AAEzC;AACA;AACA;AACA;AACe,MAAMG,gBAAgB,SAASC,oBAAW,CAAC;EACxD;AACF;AACA;AACA;EACE,IAAIC,QAAQA,CAAA,EAAG;IACb,MAAM,IAAIC,KAAK,CAAC,uCAAuC,CAAC;EAC1D;;EAEA;AACF;AACA;AACA;AACA;EACE,IAAIC,YAAYA,CAAA,EAAG;IACjB,OAAO,IAAI,CAACF,QAAQ,CAACG,MAAM;EAC7B;;EAEA;AACF;AACA;AACA;AACA;AACA;EACE;EACAC,cAAcA,CAACC,IAAI,EAAE;IACnB,OAAO,EAAE;EACX;;EAEA;AACF;AACA;AACA;AACA;EACEC,WAAWA,CAACD,IAAI,EAAE;IAChB,MAAME,IAAI,GAAG,IAAI,CAACH,cAAc,CAACC,IAAI,CAAC;IAEtC,IAAIE,IAAI,KAAK,IAAI,EAAE;MACjB,OAAO,IAAI;IACb;IAEA,OAAO;MACLC,QAAQ,EAAE,IAAI,CAACN,YAAY;MAC3BF,QAAQ,EAAE,IAAI,CAACA,QAAQ;MACvBI,cAAc,EAAEG;IAClB,CAAC;EACH;;EAEA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACE;EACAE,qBAAqBA,CAACJ,IAAI,EAAEK,UAAU,EAAEC,QAAQ,EAAE;IAChD,MAAM,IAAIV,KAAK,CAAC,uCAAuC,CAAC;EAC1D;;EAEA;AACF;AACA;AACA;AACA;EACEW,mBAAmBA,CAACP,IAAI,EAAE;IACxB,OAAO,iBAAiB,IAAI,CAACL,QAAQ,CAACa,QAAQ,CAAC,CAAC,QAAQR,IAAI,CAACS,QAAQ,EAAE;EACzE;;EAEA;AACF;AACA;AACA;AACA;AACA;EACEC,YAAYA,CAACV,IAAI,EAAEW,YAAY,EAAE;IAC/B,IAAI;MACF,MAAMC,OAAO,GAAG,IAAI,CAACX,WAAW,CAACD,IAAI,CAAC;MAEtC,IAAI,CAACY,OAAO,EAAE;QACZD,YAAY,CAAC,IAAI,EAAEE,8BAAW,CAACC,IAAI,EAAGC,IAAI,IAAKA,IAAI,CAAC,CAAC,CAAC;QACtD;MACF;MAEA,IAAI,CAACC,OAAO,CAACC,IAAI,CAAC,CAACL,OAAO,CAAC,EAAE,CAACM,GAAG,EAAE,CAACC,MAAM,CAAC,GAAG,EAAE,KAAK;QACnD,IAAID,GAAG,EAAE;UACPP,YAAY,CAACO,GAAG,CAAC;QACnB,CAAC,MAAM,IAAIC,MAAM,CAACC,UAAU,CAACC,KAAK,KAAKR,8BAAW,CAACC,IAAI,CAACO,KAAK,EAAE;UAC7DV,YAAY,CAACO,GAAG,EAAEC,MAAM,CAACC,UAAU,EAAGL,IAAI,IAAKA,IAAI,CAAC,CAAC,CAAC;QACxD,CAAC,MAAM;UACL,IAAI,CAACX,qBAAqB,CAACJ,IAAI,EAAEmB,MAAM,CAACG,eAAe,EAAGC,WAAW,IAAK;YACxEZ,YAAY,CAACY,WAAW,EAAEV,8BAAW,CAACC,IAAI,EAAGC,IAAI,IAAKA,IAAI,CAAC,CAAC,CAAC;UAC/D,CAAC,CAAC;QACJ;MACF,CAAC,CAAC;IACJ,CAAC,CAAC,OAAOzB,CAAC,EAAE;MACVqB,YAAY,CAACrB,CAAC,CAAC;IACjB;EACF;AACF;AAACkC,OAAA,CAAAhC,OAAA,GAAAC,gBAAA","ignoreList":[]}
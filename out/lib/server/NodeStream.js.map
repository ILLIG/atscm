{"version":3,"file":"NodeStream.js","names":["_stream","require","_gulplog","_interopRequireDefault","_ProjectConfig","_NodeBrowser","e","__esModule","default","NodeStream","Readable","constructor","nodesToBrowse","options","Array","length","Error","ignoreNodes","Object","assign","objectMode","recursive","undefined","Project","_start","Date","now","nodes","filter","nodeId","ignored","isIgnored","Logger","warn","info","_isDestroyed","_browser","NodeBrowser","onNode","node","match","push","stop","onEnd","destroy","onError","err","isDestroyed","emit","_read","start","_destroy","callback","then","catch","destroyErr","processed","_pushed","size","opsPerSecond","exports"],"sources":["../../../src/lib/server/NodeStream.js"],"sourcesContent":["import { Readable } from 'stream';\r\nimport Logger from 'gulplog';\r\nimport Project from '../../config/ProjectConfig';\r\nimport NodeBrowser from './NodeBrowser';\r\n\r\n/**\r\n * A stream of server nodes.\r\n */\r\nexport default class NodeStream extends Readable {\r\n  /**\r\n   * Creates new node stream.\r\n   * @param {NodeId[]} nodesToBrowse The nodes to browse.\r\n   * @param {Object} [options] The options to use.\r\n   * @param {boolean} [options.recursive] If the stream should recurse child nodes.\r\n   * @param {NodeId[]} [options.ignoreNodes] The nodes to ignore.\r\n   */\r\n  constructor(nodesToBrowse, options = {}) {\r\n    if (!nodesToBrowse || !(nodesToBrowse instanceof Array) || nodesToBrowse.length === 0) {\r\n      throw new Error('nodesToBrowse is required');\r\n    }\r\n\r\n    if (options && options.ignoreNodes && !(options.ignoreNodes instanceof Array)) {\r\n      throw new Error('ignoreNodes must be an array of node ids');\r\n    }\r\n\r\n    super(Object.assign({}, options, { objectMode: true }));\r\n\r\n    // Handle options\r\n    /**\r\n     * If the discovered nodes should be browsed as well.\r\n     * @type {Boolean}\r\n     */\r\n    this.recursive = true;\r\n    if (options.recursive !== undefined) {\r\n      this.recursive = options.recursive;\r\n    }\r\n\r\n    let ignoreNodes = Project.ignoreNodes;\r\n    if (options.ignoreNodes !== undefined) {\r\n      ignoreNodes = options.ignoreNodes;\r\n    }\r\n\r\n    /**\r\n     * The timestamp when the stream started.\r\n     * @type {number}\r\n     */\r\n    this._start = Date.now();\r\n\r\n    const nodes = nodesToBrowse.filter((nodeId) => {\r\n      // FIXME: Move to node browser and implement\r\n      const ignored = false && this.isIgnored({ nodeId });\r\n\r\n      if (ignored) {\r\n        Logger.warn(`${nodeId} is set to be browsed, but ignored.`);\r\n        Logger.info(` - Remove ${nodeId} from Atviseproject#nodes if this is intentionally.`);\r\n      }\r\n\r\n      return !ignored;\r\n    });\r\n\r\n    if (!nodes.length) {\r\n      throw new Error('Nothing to browse');\r\n    }\r\n\r\n    /**\r\n     * If the stream is destroyed.\r\n     * @type {boolean}\r\n     */\r\n    this._isDestroyed = false;\r\n\r\n    // Write nodes to read\r\n\r\n    /**\r\n     * The stream's browser\r\n     * @type {NodeBrowser}\r\n     */\r\n    this._browser = new NodeBrowser({\r\n      nodes,\r\n      ignoreNodes,\r\n      recursive: options.recursive === undefined ? true : options.recursive,\r\n    });\r\n\r\n    this._browser.onNode = (node) => {\r\n      if (node.nodeId.match(/\\s$/)) {\r\n        Logger.warn(`Node '${node.nodeId}' has trailing spaces in it's name.`);\r\n        Logger.info(' - Rename it to prevent errors on windows.');\r\n      }\r\n      if (!this.push(node)) {\r\n        this._browser.stop();\r\n      }\r\n    };\r\n\r\n    this._browser.onEnd = () => {\r\n      this.push(null);\r\n      this.destroy();\r\n    };\r\n\r\n    this._browser.onError = (err) => {\r\n      if (this.isDestroyed) {\r\n        return;\r\n      }\r\n      this.emit('error', err);\r\n      this.destroy();\r\n    };\r\n  }\r\n\r\n  /**\r\n   * If the stream is destoyed.\r\n   * @type {boolean}\r\n   */\r\n  get isDestroyed() {\r\n    return this._isDestroyed;\r\n  }\r\n\r\n  /**\r\n   * Starts the browser.\r\n   */\r\n  _read() {\r\n    this._browser.start();\r\n  }\r\n\r\n  /**\r\n   * Destroys the stream.\r\n   * @param {?Error} err The error that caused the destroy.\r\n   * @param {function(err: ?Error): void} callback Called once finished.\r\n   */\r\n  _destroy(err, callback) {\r\n    this._isDestroyed = true;\r\n\r\n    super.destroy(err, () => {\r\n      this._browser\r\n        .destroy()\r\n        .then(() => callback(err))\r\n        .catch((destroyErr) => callback(err || destroyErr));\r\n    });\r\n  }\r\n\r\n  /**\r\n   * The number of processed nodes.\r\n   * @type {number}\r\n   */\r\n  get processed() {\r\n    return this._browser._pushed.size;\r\n  }\r\n\r\n  /**\r\n   * The number of processed chunks per second.\r\n   * @type {number}\r\n   */\r\n  get opsPerSecond() {\r\n    return this.processed / ((Date.now() - this._start) / 1000) || 0;\r\n  }\r\n}\r\n"],"mappings":"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","ignoreList":[]}
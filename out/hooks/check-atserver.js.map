{"version":3,"file":"check-atserver.js","names":["_opcua_node_ids","require","_fsExtra","_semver","_gulplog","_interopRequireDefault","_prompts","_chalk","_api","_package","_fs","_NodeId","e","__esModule","default","ownKeys","r","t","Object","keys","getOwnPropertySymbols","o","filter","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","arguments","length","forEach","_defineProperty","getOwnPropertyDescriptors","defineProperties","defineProperty","_toPropertyKey","value","configurable","writable","i","_toPrimitive","Symbol","toPrimitive","call","TypeError","String","Number","_objectWithoutProperties","_objectWithoutPropertiesLoose","n","indexOf","propertyIsEnumerable","hasOwnProperty","atserverVersionNodeId","NodeId","VariableIds","Server_ServerStatus_BuildInfo_SoftwareVersion","loadProjectRequirement","packageManifest","readJson","engines","atserver","loadRemoteVersion","raw","readNode","coerce","version","askForConfirmation","_ref","onAsk","options","process","stdin","isTTY","prompts","type","name","confirmed","approveToContinue","log","continueOnError","error","warn","red","message","shouldContinue","Logger","checkAtserver","context","debug","atscmRequirement","projectRequirement","remoteVersion","Promise","all","satisfies","yellow","gtr","info","minVersion","updatePackage","Error","updateJson","current"],"sources":["../../src/hooks/check-atserver.ts"],"sourcesContent":["import { VariableIds } from 'node-opcua/lib/opcua_node_ids';\r\nimport { readJson } from 'fs-extra';\r\nimport { coerce, satisfies, gtr, minVersion } from 'semver';\r\nimport Logger from 'gulplog';\r\nimport prompts from 'prompts';\r\nimport { red, yellow } from 'chalk';\r\nimport { readNode } from '../api';\r\nimport { engines } from '../../package.json';\r\nimport { updateJson } from '../lib/helpers/fs';\r\nimport NodeId from '../lib/model/opcua/NodeId';\r\nimport { HookContext } from './hooks';\r\n\r\nconst atserverVersionNodeId = new NodeId(\r\n  `ns=0;i=${VariableIds.Server_ServerStatus_BuildInfo_SoftwareVersion}`\r\n);\r\n\r\nexport async function loadProjectRequirement(): Promise<string> {\r\n  const packageManifest = await readJson('./package.json');\r\n\r\n  return packageManifest.engines && packageManifest.engines.atserver;\r\n}\r\n\r\nexport async function loadRemoteVersion(): Promise<string> {\r\n  const raw = (await readNode(atserverVersionNodeId)).value;\r\n\r\n  return coerce(raw).version;\r\n}\r\n\r\nexport async function askForConfirmation({\r\n  onAsk,\r\n  ...options\r\n}: {\r\n  message: string;\r\n  onAsk?: () => void;\r\n}): Promise<boolean> {\r\n  if (!process.stdin.isTTY) return false;\r\n\r\n  if (onAsk) onAsk();\r\n\r\n  return (\r\n    await prompts({\r\n      type: 'confirm',\r\n      name: 'confirmed',\r\n      ...options,\r\n    })\r\n  ).confirmed;\r\n}\r\n\r\nexport async function approveToContinue(\r\n  { log, continueOnError }: HookContext,\r\n  error: Error\r\n): Promise<void> {\r\n  if (continueOnError) {\r\n    log.warn(red(error.message));\r\n    log.warn(`Using --continue, skipping...`);\r\n    return;\r\n  }\r\n\r\n  const shouldContinue = await askForConfirmation({\r\n    onAsk: () => Logger.error(red(error.message)),\r\n    message: 'Do you want to continue anyway?',\r\n  });\r\n\r\n  if (!shouldContinue) {\r\n    throw error;\r\n  }\r\n}\r\n\r\nexport default async function checkAtserver(context: HookContext): Promise<{ version: string }> {\r\n  const { log } = context;\r\n\r\n  log.debug('Checking atserver version');\r\n\r\n  const atscmRequirement = engines.atserver;\r\n\r\n  const [projectRequirement, remoteVersion] = await Promise.all([\r\n    loadProjectRequirement(),\r\n    loadRemoteVersion(),\r\n  ]);\r\n\r\n  if (!satisfies(remoteVersion, atscmRequirement)) {\r\n    log.debug(`Version ${remoteVersion} does not satisfy requirement ${atscmRequirement}`);\r\n    log.warn(\r\n      yellow(\r\n        `Your atvise server version (${remoteVersion}) is not supported, it may or may not work.`\r\n      )\r\n    );\r\n\r\n    if (gtr(remoteVersion, atscmRequirement)) {\r\n      log.info(\r\n        `You're running a newer version of atvise server. Please run 'atscm update' to check for updates.`\r\n      );\r\n    } else {\r\n      log.info(`Please upgrade to atserver ${minVersion(atscmRequirement)} or above.`);\r\n    }\r\n  }\r\n\r\n  let updatePackage = false;\r\n  if (!projectRequirement) {\r\n    log.info(`Your package.json file doesn't specify an atserver version, adding it...`);\r\n\r\n    updatePackage = true;\r\n  } else if (!satisfies(remoteVersion, projectRequirement)) {\r\n    await approveToContinue(\r\n      context,\r\n      new Error(\r\n        `Your project is setup with atserver ${projectRequirement} but you're using ${remoteVersion}`\r\n      )\r\n    );\r\n\r\n    updatePackage = await askForConfirmation({\r\n      message: `Use atvise server ${remoteVersion} as new default?`,\r\n    });\r\n  } else {\r\n    log.debug(`Running against atserver ${remoteVersion}`);\r\n  }\r\n\r\n  if (updatePackage) {\r\n    await updateJson<{ engines?: { atserver?: string } }>('./package.json', (current) => {\r\n      /* eslint-disable no-param-reassign */\r\n      if (!current.engines) current.engines = {};\r\n      current.engines.atserver = remoteVersion;\r\n      /* eslint-enable no-param-reassign */\r\n\r\n      return current;\r\n    });\r\n  }\r\n\r\n  return { version: remoteVersion };\r\n}\r\n"],"mappings":"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","ignoreList":[]}